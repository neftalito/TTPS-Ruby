<header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-6">
  <div>
    <p class="text-sm uppercase tracking-widest text-proyecto-text/30">Productos</p>
    <h1 class="text-3xl font-bold text-proyecto-primary">Catálogo de productos</h1>
    <p class="text-proyecto-text/60">Gestioná el inventario, el stock y la publicación de tus productos.</p>
  </div>

  <% if can? :create, Product %>
    <%= link_to new_backstore_product_path,
                class: "inline-flex items-center gap-2 px-4 py-2 rounded-md bg-proyecto-primary text-proyecto-bg font-semibold hover:bg-proyecto-accent w-full sm:w-auto justify-center" do %>
      <i class="fa-solid fa-circle-plus"></i>
      <span>Nuevo producto</span>
    <% end %>
  <% end %>
</header>

<div class="bg-white p-4 mb-4 rounded-lg border border-proyecto-secondary shadow">
  <%= form_with url: backstore_products_path,
                method: :get,
                local: true,
                class: "space-y-4" do |f| %>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">

      <div class="w-full">
        <%= f.label :name_q, "Nombre del Disco", class: "block text-sm font-medium text-proyecto-primary" %>
        <%= f.text_field :name_q, value: params[:name_q],
                             placeholder: "Título del álbum",
                             class: "mt-1 px-3 py-1 border rounded-md w-full" %>
      </div>

      <div class="w-full">
        <%= f.label :author_q, "Nombre del Artista", class: "block text-sm font-medium text-proyecto-primary" %>
        <%= f.text_field :author_q, value: params[:author_q],
                             placeholder: "Autor o banda",
                             class: "mt-1 px-3 py-1 border rounded-md w-full" %>
      </div>

      <div class="w-full">
        <%= f.label :category_id, "Género", class: "block text-sm font-medium text-proyecto-primary" %>
        <%= f.select :category_id,
                      [["Todos los géneros", ""]] + Category.all.map { |c| [c.name, c.id] },
                      { selected: params[:category_id] },
                      class: "mt-1 px-3 py-1 border rounded-md w-full" %>
      </div>

      <div class="w-full">
        <%= f.label :status, "Estado", class: "block text-sm font-medium text-proyecto-primary" %>
        <%= f.select :status,
                      [["Activos", ""], ["Eliminados", "deleted"], ["Todos", "all"]],
                      { selected: params[:status] },
                      class: "mt-1 px-3 py-1 border rounded-md w-full" %>
      </div>
      <div class="w-full">
        <%= f.label :product_type, "Tipo", class: "block text-sm font-medium text-proyecto-primary" %>
        <%= f.select :product_type,
                      [["Todos los tipos", "all"], ["Vinilos", "vinyl"], ["CDs", "cd"]],
                      { selected: params[:product_type] || "all" },
                      class: "mt-1 px-3 py-1 border rounded-md w-full" %>
      </div>

      <div class="w-full">
        <%= f.label :condition, "Condición", class: "block text-sm font-medium text-proyecto-primary" %>
        <%= f.select :condition,
                      [["Todas las condiciones", "all"], ["Nuevos", "new"], ["Usados", "used"]],
                      { selected: params[:condition] || "all" },
                      class: "mt-1 px-3 py-1 border rounded-md w-full" %>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:max-w-md">
      <%= f.button type: :submit,
                   name: nil,
                   class: "inline-flex items-center justify-center gap-2 px-4 py-2 bg-proyecto-primary text-proyecto-bg rounded-md hover:bg-proyecto-accent w-full text-center cursor-pointer" do %>
        <i class="fa-solid fa-filter"></i>
        <span>Filtrar</span>
      <% end %>

      <%= link_to backstore_products_path,
                  class: "inline-flex items-center justify-center gap-2 px-4 py-2 bg-proyecto-primary text-proyecto-bg rounded-md hover:bg-proyecto-accent w-full text-center" do %>
        <i class="fa-solid fa-eraser"></i>
        <span>Limpiar filtros</span>
      <% end %>
    </div>

  <% end %>
</div>

<% product_columns = [
  { header: "ID", attribute: :id },
  { header: "Nombre", attribute: :name },
  { header: "Tipo", attribute: :label_for_type },
  { header: "Condición", attribute: :label_for_condition },
  {
    header: "Categoría",
    value: ->(product) { product.category&.name || "Sin categoría" }
  },
  {
    header: "Precio",
    cell_class: "px-6 py-4 whitespace-nowrap font-semibold text-proyecto-primary",
    value: ->(product) { number_to_currency(product.price || 0, unit: "$", separator: ",", delimiter: ".", format:"%u%n") }
  },
  {
    header: "Stock",
    cell_class: "px-6 py-4 whitespace-nowrap font-semibold",
    value: ->(product) do
      stock_class = product.stock.to_i.positive? ? "text-proyecto-success" : "text-proyecto-error"
      content_tag(:span, product.stock || 0, class: stock_class)
    end
  },
  {
    header: "Estado",
    cell_class: "px-6 py-4 whitespace-nowrap",
    value: ->(product) do
      if product.deleted?
        content_tag(:span, "Eliminado", class: "px-3 py-1 rounded-full text-xs font-semibold bg-proyecto-error/10 text-proyecto-error")
      else
        content_tag(:span, "Activo", class: "px-3 py-1 rounded-full text-xs font-semibold bg-proyecto-success/10 text-proyecto-success")
      end
    end
  }
] %>

<% product_actions = lambda do |product|
  if product.deleted?
    if can? :restore, product
      link_to "Restaurar",
              restore_backstore_product_path(product),
              data: { turbo_method: :patch, turbo_confirm: "¿Seguro que querés restaurar este producto?" },
              class: "px-3 py-2 bg-proyecto-success text-white hover:bg-proyecto-success/90 rounded-md text-sm w-full sm:w-auto text-center"
    end
  else
    buttons = []

    if can? :read, product
      buttons << link_to(
        "Ver",
        backstore_product_path(product),
        class: "px-3 py-2 bg-proyecto-info text-proyecto-bg hover:bg-proyecto-info/90 rounded-md text-sm w-full sm:w-auto text-center"
      )
    end

    if can? :update, product
      buttons << link_to(
        "Editar",
        edit_backstore_product_path(product),
        class: "px-3 py-2 bg-proyecto-primary text-proyecto-bg hover:bg-proyecto-primary/90 rounded-md text-sm w-full sm:w-auto text-center"
      )
    end

    if can? :destroy, product
      buttons << link_to(
        "Eliminar",
        backstore_product_path(product),
        data: { turbo_method: :delete, turbo_confirm: "¿Seguro que querés eliminar este producto?" },
        class: "px-3 py-2 bg-proyecto-error text-proyecto-bg hover:bg-proyecto-error/90 rounded-md text-sm w-full sm:w-auto text-center"
      )
    end

    safe_join(buttons)
  end
end %>

<div class="shadow border border-proyecto-secondary rounded-lg bg-white p-2 sm:p-4">
  <%= render "backstore/shared/resource_table",
              collection: @products,
              columns: product_columns,
              row_class: ->(product) { product.deleted? ? "bg-proyecto-secondary/20" : nil },
              empty_message: "No hay productos para mostrar.",
              actions: product_actions %>
</div>

<%= render "shared/pagination", collection: @products, params: request.query_parameters %>
