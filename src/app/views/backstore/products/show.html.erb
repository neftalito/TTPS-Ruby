<div class="max-w-6xl mx-auto p-6">
  <div class="flex items-center justify-between mb-6">
    <div>
      <%= link_to backstore_products_path, class: "inline-flex items-center gap-2 px-3 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0L2.586 11l3.707-3.707a1 1 0 011.414 1.414L5.414 11l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
        Volver
      <% end %>
    </div>

    <div class="text-right">
      <p class="text-sm uppercase tracking-wider text-gray-500">Producto</p>
      <h1 class="text-2xl font-semibold text-gray-800"><%= @product.name %></h1>
      <p class="text-base text-gray-600"><%= @product.author %></p>

      <%# Tipo robusto: intenta el accessor del enum, si falla usa el valor crudo y normaliza variantes %>
      <% raw_type = @product.respond_to?(:product_type) ? @product.product_type : @product[:product_type] %>
      <% raw_type = raw_type.to_s.strip.downcase %>
      <% type_label = case raw_type
          when 'vinyl', 'viniyl' then 'Vinilo'
          when 'cd' then 'CD'
          when '' then nil
          else raw_type.capitalize
          end %>

      <% if type_label.present? %>
        <p class="mt-2">
          <span class="inline-block px-3 py-1 text-sm font-semibold bg-gray-100 text-gray-800 rounded">
            <%= type_label %>
          </span>
          <%# muestra el valor crudo para debugging si difiere del label reconocido %>
          <% if raw_type.present? && raw_type.downcase != type_label.downcase %>
            <span class="ml-2 text-xs text-gray-500">(<%= @product[:product_type].to_s %>)</span>
          <% end %>
        </p>
      <% end %>
    </div>
  </div>

  <div class="flex flex-col md:flex-row gap-6">
    <div class="md:w-1/2">
      <%# CARRUSEL DE IM√ÅGENES %>
      <div id="carousel-<%= @product.id %>" class="relative bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="carousel-track flex transition-transform duration-500 ease-in-out">
          <% if @product.images.attached? %>
            <% @product.images.each do |img| %>
              <div class="carousel-slide min-w-full flex-shrink-0 flex items-center justify-center p-4 bg-gray-50">
                <%= image_tag url_for(img), class: "max-h-96 object-contain" %>
              </div>
            <% end %>
          <% else %>
            <div class="carousel-slide min-w-full flex-shrink-0 p-8 text-center text-gray-500">
              Sin im√°genes
            </div>
          <% end %>
        </div>

        <%# BOTONES DE NAVEGACI√ìN %>
        <button data-action="prev" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white/100 rounded-full p-2 shadow">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 16.293a1 1 0 010-1.414L15.586 11H4a1 1 0 110-2h11.586l-3.293-3.293a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
        </button>
        <button data-action="next" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white/100 rounded-full p-2 shadow">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-700 transform rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 16.293a1 1 0 010-1.414L15.586 11H4a1 1 0 110-2h11.586l-3.293-3.293a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
        </button>

        <%# INDICADORES %>
        <div class="absolute bottom-3 left-3 flex items-center gap-3">
          <div class="text-sm text-gray-600 bg-white/80 px-2 py-1 rounded">
            <%= pluralize(@product.images.attached? ? @product.images.count : 0, 'imagen') %>
          </div>
          <div class="flex gap-2">
            <% slides_count = @product.images.attached? ? @product.images.count : 1 %>
            <% slides_count.times do |i| %>
              <button data-indicator-index="<%= i %>" class="w-2 h-2 rounded-full bg-white/60 ring-1 ring-gray-200"></button>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="md:w-1/2 space-y-6">
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded">
          <p class="text-base font-semibold text-gray-800">Categor√≠a</p>
          <p class="mt-1 text-lg font-medium text-gray-900"><%= @product.category&.name || "‚Äî" %></p>
        </div>

        <div class="bg-gray-50 p-4 rounded">
          <p class="text-base font-semibold text-gray-800">Estado</p>
          <p class="mt-1 text-lg font-medium text-gray-900">
            <%= @product.condition.humanize %>
          </p>
        </div>

        <div class="bg-gray-50 p-4 rounded">
          <p class="text-base font-semibold text-gray-800">Precio</p>
          <p class="mt-1 text-lg font-semibold text-indigo-600"><%= number_to_currency(@product.price || 0, unit: "$", separator: ",", delimiter: ".", format:"%u%n") %></p>
        </div>

        <div class="bg-gray-50 p-4 rounded">
          <p class="text-base font-semibold text-gray-800">Stock disponible</p>
          <p class="mt-1 text-lg font-semibold <%= (@product.try(:stock) || 0).to_i > 0 ? 'text-green-600' : 'text-red-600' %>">
            <%= @product.try(:stock) || 0 %>
          </p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div>
          <%= link_to 'Editar', edit_backstore_product_path(@product), class: "px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700", aria: { label: "Editar producto" } if defined?(can?) ? can?(:update, @product) : true %>
        </div>

        <div>
          <%= button_to 'Dar de baja', backstore_product_path(@product), method: :delete, data: { confirm: 'Confirmar baja l√≥gica?' }, class: "px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700", form: { class: "inline-block" } if defined?(can?) ? can?(:destroy, @product) : true %>
        </div>
      </div>


      <div>
        <p class="text-base font-semibold text-gray-800">Descripci√≥n</p>
        <div class="mt-2 prose max-w-none text-gray-800">
          <%= simple_format(@product.try(:description) || "") %>
        </div>
      </div>
      
      <%# AUDIO PREVIEW (Si es disco usado y tiene audio adjunto) %>
      <% if @product.condition == "used" && @product.audio.attached? %>
        <div class="bg-gray-100 p-4 rounded mt-4">
          <p class="text-base font-semibold text-gray-800 mb-2">Muestra de Audio üéß</p>
          <audio controls class="w-full">
            <source src="<%= url_for(@product.audio) %>" type="<%= @product.audio.content_type %>">
            Tu navegador no soporta el elemento de audio.
          </audio>
        </div>
      <% end %>
      
    </div>
  </div>
</div>

<script>
  (function() {
    function initCarousel(rootId) {
      const root = document.getElementById(rootId);
      if (!root) return;

      const track = root.querySelector('.carousel-track');
      const slides = Array.from(root.querySelectorAll('.carousel-slide'));
      
      const prevBtn = root.querySelector('button[data-action="prev"]');
      const nextBtn = root.querySelector('button[data-action="next"]');
      const indicators = Array.from(root.querySelectorAll('[data-indicator-index]'));
      
      let index = 0;
      const total = slides.length; 
      let timer = null;
      
      // Ocultar botones e indicadores si solo hay una imagen o ninguna
      if (total <= 1) {
          prevBtn && (prevBtn.style.display = 'none');
          nextBtn && (nextBtn.style.display = 'none');
          indicators.forEach(b => b.style.display = 'none');
          return; 
      }

      const go = (i) => {
        index = (i + total) % total;
        
        // Desplazamiento
        track.style.transform = `translateX(-${index * 100}%)`;
        
        // Actualiza los indicadores
        indicators.forEach((b, idx) => {
          // Remover y a√±adir clases para los estados (activo/inactivo)
          b.classList.remove('bg-indigo-600', 'ring-2', 'ring-indigo-300'); // Quita activo
          b.classList.add('bg-white/60', 'ring-1', 'ring-gray-200'); // Pone inactivo
          
          if (idx === index) {
            b.classList.remove('bg-white/60', 'ring-1', 'ring-gray-200'); // Quita inactivo
            b.classList.add('bg-indigo-600', 'ring-2', 'ring-indigo-300'); // Pone activo
          }
        });
      };

      const restart = () => { stop(); start(); };

      // Adjuntar eventos a botones e indicadores
      prevBtn && prevBtn.addEventListener('click', (e) => { 
        e.preventDefault(); 
        go(index - 1); 
        restart(); 
      });
      nextBtn && nextBtn.addEventListener('click', (e) => { 
        e.preventDefault(); 
        go(index + 1); 
        restart(); 
      });
      indicators.forEach((b, idx) => b.addEventListener('click', () => { 
        go(idx); 
        restart(); 
      }));

      // Funciones de temporizador para el carrusel autom√°tico
      function start() {
        if (timer) clearInterval(timer);
        timer = setInterval(() => go(index + 1), 4000);
      }
      function stop() { if (timer) { clearInterval(timer); timer = null; } }

      // Manejo de mouse para pausar
      root.addEventListener('mouseenter', stop);
      root.addEventListener('mouseleave', start);
      
      // Inicializar y comenzar
      go(0);
      start();
    }

    const carouselId = 'carousel-<%= @product.id %>';
    
    const run = () => {
      // Retraso de seguridad para cargas de Turbo
      setTimeout(() => {
        initCarousel(carouselId);
      }, 50); 
    };
    
    // Ejecutar en todas las cargas de contenido
    document.addEventListener('turbo:load', run); 
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', run);
    } else {
      run();
    }
  })();
</script>